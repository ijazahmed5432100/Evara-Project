<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--=============== FLATICON ===============-->
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/2.0.0/uicons-regular-straight/css/uicons-regular-straight.css"


    />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'adminuser/img/order.png' %}">

    
    <!--=============== SWIPER CSS ===============-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
/>

      <!-- External CSS (e.g., Bootstrap) -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">


    <!--=============== CSS ===============-->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />



    <!-- Razorpay JS -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>




    <title>Ecommerce Website</title>
  </head>
  <body>
    <!--=============== HEADER ===============-->
    
    {% include 'header.html' %}







<style>
    .confirmation-container {
        max-width: 450px;
        margin: 2.5rem auto;
        padding: 1.5rem;
        text-align: center;
    }

    .success-icon {
        width: 60px;
        height: 60px;
        background-color: #28a745;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }

    .success-icon i {
        color: white;
        font-size: 30px;
    }

    .order-details {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.25rem;
        margin: 1.25rem 0;
    }

    .action-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .thank-you-message {
        color: #6c757d;
        margin: 1rem 0;
    }

    .confirmation-card {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        background-color: white;
        padding: 1.5rem;
    }

    .order-number {
        background-color: #e9ecef;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        display: inline-block;
        margin: 0.75rem 0;
        font-family: monospace;
        font-size: 1em;
    }

    h1 {
        font-size: 1.75rem;
        margin-bottom: 1rem;
    }

    h4 {
        font-size: 1.2rem;
        margin-bottom: 0.75rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
    }

    @media (max-width: 768px) {
        .confirmation-container {
            margin: 1.5rem auto;
            padding: 1rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-buttons .btn {
            width: 100%;
        }
    }
</style>




<div class="confirmation-container">
    <div class="confirmation-card">
        {% if is_success %}
        <div class="success-icon">
            <i class="bi bi-check-lg"></i>
        </div>
        <h1>Order Confirmed!</h1>
        {% else %}
        <div class="success-icon" style="background-color: #dc3545;">
            <i class="bi bi-x-lg"></i>
        </div>
        <h1>Payment Failed</h1>
        {% endif %}

        <div class="order-details">
            <h4>Order Summary</h4>
            <div class="order-number">Order #{{ order_number }}</div>
            <div class="mt-3 pt-3 border-top">
                <strong>Total Amount:</strong> â‚¹{{ grand_total|floatformat:2 }}
            </div>
            <div class="mt-3 pt-3 border-top">
                <strong>Payment Status:</strong> {{ payment_status }}
            </div>
        </div>

        <div class="thank-you-message">
            {% if is_success %}
            <p class="mb-1">Thank you for shopping with us!</p>
            {% else %}
            <p class="mb-1">Something went wrong with your payment. Please try again or contact support.</p>
            {% endif %}
        </div>

        <div class="action-buttons">
            <a href="{% url 'user_orders' %}" class="btn btn-outline-primary">
                <i class="bi bi-box-seam me-2"></i>Track Order
            </a>
            <a href="{% url 'home' %}" class="btn btn-primary">
                <i class="bi bi-cart me-2"></i>Continue Shopping
            </a>
            {% if show_retry_button %}
            <form method="POST" action="{% url 'payments:initiate_payment' %}" id="retry-payment-form" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning" id="retry-button">
                    <i class="bi bi-arrow-repeat me-2"></i>Retry Payment
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>







<!-- External JS (e.g., Bootstrap) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">




<!-- Razorpay JS -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


<!-- Retry Payment JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const retryForm = document.getElementById('retry-payment-form');
        if (retryForm) {
            retryForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                console.log('Form submission intercepted');

                fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams(new FormData(this))
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    if (data.razorpay_order_id) {
                        const options = {
                            key: data.razorpay_merchant_key,
                            amount: data.razorpay_amount,
                            currency: data.currency,
                            name: "URBAN EDGE",
                            order_id: data.razorpay_order_id,
                            handler: function(response) {
                                fetch(data.callback_url, {
                                    method: "POST",
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRFToken': '{{ csrf_token }}'
                                    },
                                    body: new URLSearchParams({
                                        'razorpay_payment_id': response.razorpay_payment_id,
                                        'razorpay_order_id': response.razorpay_order_id,
                                        'razorpay_signature': response.razorpay_signature
                                    })
                                })
                                .then(resp => {
                                    if (resp.ok) {
                                        window.location.href = `/payments/success/${data.django_order_id}/`;
                                    } else {
                                        window.location.href = `/payments/failure/${data.django_order_id}/`;
                                    }
                                })
                                .catch(error => {
                                    console.error('Error in callback:', error);
                                    window.location.href = `/payments/failure/${data.django_order_id}/`;
                                });
                            },
                            modal: {
                                ondismiss: function() {
                                    window.location.href = `/payments/failure/${data.django_order_id}/`;
                                }
                            },
                            prefill: {
                                name: "{{ request.user.username }}",
                                email: "{{ request.user.email }}",
                                contact: "9995160852"
                            },
                            theme: {
                                color: "#0d6efd"
                            },
                            method: {
                                netbanking: true,
                                card: true,
                                wallet: true,
                                upi: true
                            }
                        };
                        const rzp1 = new Razorpay(options);
                        rzp1.open();
                    } else {
                        alert(data.error || "Error initiating retry payment.");
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert("Error processing retry request.");
                });
            });
        } else {
            console.log('Retry form not found');
        }
    });
</script>






</body>

</html>